# üß† –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç estimate-AI - –ø–æ–ª–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—Ç –ê –¥–æ –Ø

> **–î–ª—è —Ç–µ—Ö –∫—Ç–æ —Ö–æ—á–µ—Ç –ø–æ–Ω—è—Ç—å –ø—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é, –±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –≤–æ–¥—ã**

---

## üìå –ß—Ç–æ –≤–æ–æ–±—â–µ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç?

–≠—Ç–æ **–≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç—Å—Ç–∏–º–µ–π—Ç–æ–≤ (–æ—Ü–µ–Ω–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤)** —Å –ø–æ–º–æ—â—å—é AI.

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
1. –ó–∞—Ö–æ–¥–∏—Ç –Ω–∞ —Å–∞–π—Ç
2. –ê–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ SMS
3. –ó–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É (–Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞, –∑–∞–º–µ—Ç–∫–∏, –ø—Ä–∏–∫–ª–∞–¥—ã–≤–∞–µ—Ç —Ñ–∞–π–ª—ã)
4. –ù–∞–∂–∏–º–∞–µ—Ç Submit
5. AI –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–∑–¥–∞—ë—Ç —ç—Å—Ç–∏–º–µ–π—Ç
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –≥–æ—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:**
- –ï—Å—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ª–∏–º–∏—Ç: 3 —ç—Å—Ç–∏–º–µ–π—Ç–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ
- –ü–æ—Å–ª–µ 3-—Ö –Ω—É–∂–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ Stripe
- –í—Å—è –∏—Å—Ç–æ—Ä–∏—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Firebase

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–∏–∑ —á–µ–≥–æ —Å–æ—Å—Ç–æ–∏—Ç)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       FRONTEND (React)                   ‚îÇ
‚îÇ  - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ SMS                ‚îÇ
‚îÇ  - –§–æ—Ä–º–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è                 ‚îÇ
‚îÇ  - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ                    ‚îÇ
     ‚îÇ                    ‚îÇ
     ‚ñº                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FIREBASE   ‚îÇ    ‚îÇ   BACKEND    ‚îÇ
‚îÇ             ‚îÇ    ‚îÇ  (Node.js)   ‚îÇ
‚îÇ - Auth      ‚îÇ    ‚îÇ              ‚îÇ
‚îÇ - Database  ‚îÇ    ‚îÇ - Stripe     ‚îÇ
‚îÇ             ‚îÇ    ‚îÇ - Webhooks   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                          ‚ñº
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ    STRIPE    ‚îÇ
                   ‚îÇ  (–ü–ª–∞—Ç–µ–∂–∏)   ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                          ‚ñº
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ     n8n      ‚îÇ
                   ‚îÇ (AI –æ–±—Ä–∞–±–æ—Ç–∫–∞‚îÇ
                   ‚îÇ  workflows)  ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üé¨ –ü–æ–ª–Ω—ã–π flow –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞

### **–≠–¢–ê–ü 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–∞–π—Ç**

#### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

1. **–ë—Ä–∞—É–∑–µ—Ä –∑–∞–≥—Ä—É–∂–∞–µ—Ç** `index.html`
2. **React –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è** —á–µ—Ä–µ–∑ `main.tsx` ‚Üí `App.tsx`
3. **App.tsx –ø—Ä–æ–≤–µ—Ä—è–µ—Ç**: –µ—Å—Ç—å –ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `onAuthStateChanged` –∏–∑ Firebase Auth
   - –ï—Å–ª–∏ **–ù–ï–¢** ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
   - –ï—Å–ª–∏ **–î–ê** ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —ç—Å—Ç–∏–º–µ–π—Ç–∞

---

### **–≠–¢–ê–ü 2: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω**

#### –§–∞–π–ª: `src/components/AuthContainer.tsx`

#### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—à–∞–≥–æ–≤–æ:

**–®–∞–≥ 2.1: –í–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç: [+71234567890] [–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥]
```

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ `+71234567890`
2. –ù–∞–∂–∏–º–∞–µ—Ç "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥"
3. **Frontend**:
   - –°–æ–∑–¥–∞—ë—Ç –Ω–µ–≤–∏–¥–∏–º—É—é reCAPTCHA (–∑–∞—â–∏—Ç–∞ –æ—Ç –±–æ—Ç–æ–≤)
   - –í—ã–∑—ã–≤–∞–µ—Ç `signInWithPhoneNumber(auth, phone, verifier)`
4. **Firebase Auth**:
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç reCAPTCHA
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SMS –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç `ConfirmationResult`
5. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É

**–®–∞–≥ 2.2: –í–≤–æ–¥ –∫–æ–¥–∞ –∏–∑ SMS**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç SMS: "–í–∞—à –∫–æ–¥: 123456"
–í–∏–¥–∏—Ç —ç–∫—Ä–∞–Ω: [–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥] [–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å]
```

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∫–æ–¥ `123456`
2. –ù–∞–∂–∏–º–∞–µ—Ç "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å"
3. **Frontend**:
   - –í—ã–∑—ã–≤–∞–µ—Ç `confirmation.confirm(code)`
4. **Firebase Auth**:
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥
   - –ï—Å–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ‚Üí —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (User object)
   - –ï—Å–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ‚Üí –æ—à–∏–±–∫–∞ "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥"

**–®–∞–≥ 2.3: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è (–µ—Å–ª–∏ –ø–µ—Ä–≤—ã–π —Ä–∞–∑)**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç: [–í–∞—à–µ –∏–º—è] [–í–∞—à–∞ —Ä–æ–ª—å] [–°–æ—Ö—Ä–∞–Ω–∏—Ç—å]
```

1. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º:
   - –ï—Å—Ç—å –ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –≤ Firebase Database –ø–æ –ø—É—Ç–∏ `profiles/{uid}`?
2. –ï—Å–ª–∏ **–ù–ï–¢** (–ø–µ—Ä–≤—ã–π —Ä–∞–∑ –∑–∞—Ö–æ–¥–∏—Ç):
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø—Ä–æ—Ñ–∏–ª—è
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∏–º—è –∏ —Ä–æ–ª—å
   - –ù–∞–∂–∏–º–∞–µ—Ç "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å"
   - **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ Firebase**:
     ```javascript
     profiles/{uid}/ {
       name: "–ê–ª–µ–∫—Å–µ–π",
       role: "Developer",
       createdAt: 1234567890
     }
     ```
3. –ï—Å–ª–∏ **–î–ê** (—É–∂–µ –±—ã–ª):
   - –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–º—è –∏ —Ä–æ–ª—å –∏–∑ –±–∞–∑—ã
   - –°—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —ç—Å—Ç–∏–º–µ–π—Ç–∞

---

### **–≠–¢–ê–ü 3: –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω - —Ñ–æ—Ä–º–∞ —ç—Å—Ç–∏–º–µ–π—Ç–∞**

#### –§–∞–π–ª: `src/EstimateForm.tsx`

#### –ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:

```
Hello, –ê–ª–µ–∫—Å–µ–π
Role: Developer
Submissions: 1 

[Project / Client name        ]
[Notes to AI...                ]
[                              ]

[Add File] [Add Visual]

[Submit]
```

#### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:

1. **–ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ usage** –∏–∑ Firebase:
   ```javascript
   profiles/{uid}/usage/ {
     count: 1,           // —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª—è–ª
     paid: false,        // –µ—Å—Ç—å –ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞
     subscriptionId: null
   }
   ```
2. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å—á—ë—Ç—á–∏–∫: "Submissions: 1"
3. –ï—Å–ª–∏ `paid: true` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "(unlimited)"

---

### **–≠–¢–ê–ü 4: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É**

#### –ß—Ç–æ –º–æ–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å:

1. **Project Name** (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):
   - –ù–∞–ø—Ä–∏–º–µ—Ä: "Website for Cafe"

2. **Notes to AI**:
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è AI
   - –ù–∞–ø—Ä–∏–º–µ—Ä: "–ù—É–∂–Ω–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤—ë—Ä—Å—Ç–∫–∞, 5 —Å—Ç—Ä–∞–Ω–∏—Ü"

3. **–§–∞–π–ª—ã** (Add File):
   - –ü—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è: `.pdf`, `.doc`, `.docx`, `.txt`, `.csv`
   - –ù–∞–ø—Ä–∏–º–µ—Ä: –¢–ó –≤ PDF

4. **–í–∏–∑—É–∞–ª—ã** (Add Visual):
   - –ü—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è: `.png`, `.jpeg`
   - –ù–∞–ø—Ä–∏–º–µ—Ä: –º–∞–∫–µ—Ç—ã –¥–∏–∑–∞–π–Ω–∞, —Å–∫—Ä–∏–Ω—à–æ—Ç—ã

–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å **–æ–ø–∏—Å–∞–Ω–∏–µ**.

---

### **–≠–¢–ê–ü 5: –ù–∞–∂–∞—Ç–∏–µ Submit - –º–∞–≥–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è! ‚ú®**

#### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—à–∞–≥–æ–≤–æ:

**–®–∞–≥ 5.1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞**

```javascript
const shouldCheckout = !usage.paid && usage.count >= FREE_LIMIT;
if (shouldCheckout) {
  // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ–ø–ª–∞—Ç—É Stripe
  await goToCheckout();
  return;
}
```

- **FREE_LIMIT = 3**
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **–ù–ï –æ–ø–ª–∞—Ç–∏–ª** –ò **—É–∂–µ —Å–¥–µ–ª–∞–ª 3+ —ç—Å—Ç–∏–º–µ–π—Ç–∞** ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ Stripe checkout
- –ò–Ω–∞—á–µ ‚Üí –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–ª—å—à–µ

**–®–∞–≥ 5.2: –°–æ–∑–¥–∞–Ω–∏–µ executionId**

```javascript
const executionId = uuidv4(); // –Ω–∞–ø—Ä–∏–º–µ—Ä: "a1b2c3d4-e5f6-..."
```

–≠—Ç–æ **—É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID** –¥–ª—è —ç—Ç–æ–≥–æ —ç—Å—Ç–∏–º–µ–π—Ç–∞. –ü–æ –Ω–µ–º—É –±—É–¥–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å.

**–®–∞–≥ 5.3: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –≤ Firebase**

```javascript
profiles/{uid}/estimates/{executionId}/operations/
  ‚îî‚îÄ {pushId1}: {
       step: "Initializing estimate...",
       status: "pending",
       progress: 0
     }
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏!

**–®–∞–≥ 5.4: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö (FormData)**

```javascript
const formData = new FormData();
formData.append('executionId', executionId);
formData.append('userId', user.uid);
formData.append('project_name', "Website for Cafe");
formData.append('notes_to_ai', "–ù—É–∂–Ω–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤—ë—Ä—Å—Ç–∫–∞");
formData.append('user_phone', user.phoneNumber);
formData.append('user_name', "–ê–ª–µ–∫—Å–µ–π");
formData.append('user_role', "Developer");

// –§–∞–π–ª—ã
entries.forEach(entry => {
  formData.append('files', entry.file);
  formData.append('types', entry.type);
  formData.append('descriptions', entry.description);
});
```

**–®–∞–≥ 5.5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞**

```javascript
profiles/{uid}/estimates/{executionId}/operations/
  ‚îî‚îÄ {pushId2}: {
       step: "Sending data to n8n...",
       status: "in_progress",
       progress: 20
     }
```

**–®–∞–≥ 5.6: –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ n8n webhook**

```javascript
const resp = await fetch(
  'http://localhost:5678/webhook/79c1c326-1af6-4c73-9194-6737b093b58d',
  { method: 'POST', body: formData }
);
```

**n8n** ‚Äî —ç—Ç–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏. 

–í–Ω—É—Ç—Ä–∏ n8n —É –≤–∞—Å –µ—Å—Ç—å **workflow**, –∫–æ—Ç–æ—Ä—ã–π:
1. –ü–æ–ª—É—á–∞–µ—Ç —Ñ–∞–π–ª—ã –∏ –¥–∞–Ω–Ω—ã–µ
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ AI (–Ω–∞–ø—Ä–∏–º–µ—Ä, OpenAI GPT)
3. AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¢–ó –∏ —Ñ–∞–π–ª—ã
4. –°–æ–∑–¥–∞—ë—Ç —ç—Å—Ç–∏–º–µ–π—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ Google Docs –∏–ª–∏ Excel)
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `sharedLink` (—Å—Å—ã–ª–∫—É –Ω–∞ –≥–æ—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç)

**–®–∞–≥ 5.7: n8n –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç**

```javascript
const respJson = await resp.json();
// –Ω–∞–ø—Ä–∏–º–µ—Ä: { sharedLink: "https://docs.google.com/..." }
```

**–®–∞–≥ 5.8: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞**

```javascript
profiles/{uid}/estimates/{executionId}/ {
  projectName: "Website for Cafe",
  notes: "–ù—É–∂–Ω–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤—ë—Ä—Å—Ç–∫–∞",
  sharedLink: "https://docs.google.com/...",
  createdAt: 1234567890
}
```

–ò –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é:
```javascript
operations/
  ‚îî‚îÄ {pushId3}: {
       step: "n8n processing finished",
       status: "done",
       progress: 100
     }
```

**–®–∞–≥ 5.9: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞**

```javascript
// –ê–¢–û–ú–ê–†–ù–´–ô –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π)
await runTransaction(
  dbRef(rtdb, `profiles/${user.uid}/usage/count`),
  (c) => (c ?? 0) + 1
);
```

–°—á—ë—Ç—á–∏–∫ `usage.count` —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 1.

**–®–∞–≥ 5.10: –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–∂–∏–¥–∞–Ω–∏—è**

```javascript
navigate(`/waiting/${executionId}`);
```

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ `/waiting/a1b2c3d4-e5f6-...`

---

### **–≠–¢–ê–ü 6: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–∂–∏–¥–∞–Ω–∏—è (WaitingPage)**

#### –§–∞–π–ª: `src/WaitingPage.tsx`

#### –ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:

```
Estimate Progress

[Initializing estimate... : pending (0%)]
[Sending data to n8n... : in_progress (20%)]
[n8n processing finished : done (100%)]

[Open Estimate] ‚Üê —Å—Å—ã–ª–∫–∞ –Ω–∞ Google Docs
```

#### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ß–∏—Ç–∞–µ–º executionId –∏–∑ URL**:
   ```javascript
   const { executionId } = useParams();
   ```

2. **–ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Firebase** (real-time!):
   ```javascript
   // –°–ª—É—à–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏
   onValue(
     dbRef(rtdb, `profiles/${uid}/estimates/${executionId}/operations`),
     snapshot => {
       // –ö–∞–∂–¥—ã–π —Ä–∞–∑ –∫–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è - –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
       setProgressSteps([...]);
     }
   );

   // –°–ª—É—à–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
   onValue(
     dbRef(rtdb, `profiles/${uid}/estimates/${executionId}/sharedLink`),
     snapshot => {
       setSharedLink(snapshot.val());
     }
   );
   ```

3. **–ö–æ–≥–¥–∞ n8n –∑–∞–∫–æ–Ω—á–∏—Ç** –∏ –∑–∞–ø–∏—à–µ—Ç `sharedLink`:
   - –ü–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "Open Estimate"
   - –ö–ª–∏–∫ ‚Üí –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Google Docs —Å –≥–æ—Ç–æ–≤—ã–º —ç—Å—Ç–∏–º–µ–π—Ç–æ–º

---

### **–≠–¢–ê–ü 7: –û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)**

#### –ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å **4-–π —ç—Å—Ç–∏–º–µ–π—Ç** –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏:

```javascript
if (!usage.paid && usage.count >= 3) {
  await goToCheckout(); // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ Stripe
}
```

#### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

**–®–∞–≥ 7.1: Frontend –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç checkout session**

```javascript
// –ü–æ–ª—É—á–∞–µ–º Firebase ID token
const idToken = await user.getIdToken();

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ backend
const res = await fetch(`${API_BASE}/create-subscription`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${idToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({ priceId: STRIPE_PRICE_ID })
});

const { sessionId } = await res.json();
```

**–®–∞–≥ 7.2: Backend —Å–æ–∑–¥–∞—ë—Ç Stripe Checkout Session**

#### –§–∞–π–ª: `backend/index.js` ‚Üí `/create-subscription`

```javascript
app.post('/create-subscription', verifyToken, async (req, res) => {
  const uid = req.user.uid; // –∏–∑ Firebase token

  // 1. –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ Stripe customer –ø–æ uid
  const found = await stripe.customers.search({
    query: `metadata['uid']:'${uid}'`
  });
  let customerId = found.data[0]?.id;

  // 2. –ï—Å–ª–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ
  if (!customerId) {
    const customer = await stripe.customers.create({
      metadata: { uid, env: 'stg' }
    });
    customerId = customer.id;
  }

  // 3. –°–æ–∑–¥–∞—ë–º Checkout Session
  const session = await stripe.checkout.sessions.create({
    mode: 'subscription',
    customer: customerId,
    line_items: [{ price: STRIPE_PRICE_ID, quantity: 1 }],
    subscription_data: { metadata: { uid } },
    success_url: `${FRONTEND_URL}/?subscribed=true`,
    cancel_url: `${FRONTEND_URL}/?subscribed=false`
  });

  res.json({ sessionId: session.id });
});
```

**–ß—Ç–æ —Ç—É—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

1. **–ü—Ä–æ–≤–µ—Ä—è–µ–º Firebase token** (middleware `verifyToken`)
2. **–ò—â–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º Stripe customer**:
   - –í Stripe –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = customer
   - –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ `metadata.uid`
3. **–°–æ–∑–¥–∞—ë–º checkout session**:
   - –≠—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ Stripe –¥–ª—è –æ–ø–ª–∞—Ç—ã
   - `success_url` - –∫—É–¥–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
   - `cancel_url` - –∫—É–¥–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ

**–®–∞–≥ 7.3: –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ Stripe Checkout**

```javascript
const stripe = await stripePromise;
await stripe.redirectToCheckout({ sessionId });
```

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç **–∫—Ä–∞—Å–∏–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É Stripe**:
```
[ üí≥ Card Number ]
[ üìÖ Exp Date ]
[ üîí CVC ]
[Pay $9.99/month]
```

**–®–∞–≥ 7.4: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç**

1. –í–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
2. –ù–∞–∂–∏–º–∞–µ—Ç "Pay"
3. Stripe –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç—ë–∂
4. –°–æ–∑–¥–∞—ë—Ç—Å—è **subscription** (–ø–æ–¥–ø–∏—Å–∫–∞)

**–®–∞–≥ 7.5: Stripe –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ backend**

Stripe –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ:
```
POST /stripe-webhook
{
  type: "checkout.session.completed",
  data: {
    object: {
      subscription: "sub_xxx",
      metadata: { uid: "firebase-uid-123" }
    }
  }
}
```

**–®–∞–≥ 7.6: Backend –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç webhook**

#### –§–∞–π–ª: `backend/index.js` ‚Üí `/stripe-webhook`

```javascript
if (event.type === 'checkout.session.completed') {
  const session = event.data.object;
  const uid = session.metadata?.uid;
  const subscriptionId = session.subscription;

  // –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏
  const sub = await stripe.subscriptions.retrieve(subscriptionId);
  const status = sub.status; // "active"
  const currentPeriodEnd = sub.current_period_end * 1000;

  // –û–±–Ω–æ–≤–ª—è–µ–º Firebase Database
  await admin.database().ref(`profiles/${uid}/usage`).update({
    paid: true,                    // ‚Üê –í–û–¢ –ö–õ–Æ–ß–ï–í–û–ï!
    subscriptionId: subscriptionId,
    status: 'active',
    currentPeriodEnd: currentPeriodEnd,
    updatedAt: Date.now()
  });
}
```

**–®–∞–≥ 7.7: Firebase Database –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è**

```javascript
profiles/{uid}/usage/ {
  count: 3,
  paid: true,              // ‚Üê –¢–µ–ø–µ—Ä—å TRUE!
  subscriptionId: "sub_xxx",
  status: "active",
  currentPeriodEnd: 1735689600000
}
```

**–®–∞–≥ 7.8: Frontend –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**

–ü–æ–º–Ω–∏—Ç–µ, –≤ `EstimateForm.tsx` –µ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∞:
```javascript
useEffect(() => {
  const usageRef = dbRef(rtdb, `profiles/${user.uid}/usage`);
  return onValue(usageRef, snapshot => {
    setUsage(snapshot.val()); // REAL-TIME –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ!
  });
}, [user.uid]);
```

**–¢–µ–ø–µ—Ä—å –Ω–∞ —ç–∫—Ä–∞–Ω–µ:**
```
Submissions: 3 (unlimited) ‚Üê –ü–æ—è–≤–∏–ª–æ—Å—å!
```

**–®–∞–≥ 7.9: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –Ω–∞ —Å–∞–π—Ç**

Stripe —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞:
```
https://your-site.com/?subscribed=true
```

–¢–µ–ø–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å **–Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ** —ç—Å—Ç–∏–º–µ–π—Ç–æ–≤!

---

## üîÑ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ webhook —Å–æ–±—ã—Ç–∏—è

Stripe –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–∞–∑–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è, backend –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:

### **1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏**

```javascript
if (event.type === 'customer.subscription.updated') {
  const sub = event.data.object;
  const uid = sub.metadata?.uid;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
  await admin.database().ref(`profiles/${uid}/usage`).update({
    status: sub.status, // –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å "past_due" –µ—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞
    currentPeriodEnd: sub.current_period_end * 1000
  });
}
```

### **2. –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏**

```javascript
if (event.type === 'customer.subscription.deleted') {
  const sub = event.data.object;
  const uid = sub.metadata?.uid;
  
  await admin.database().ref(`profiles/${uid}/usage`).update({
    paid: false,        // ‚Üê –°–Ω–æ–≤–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π
    status: 'canceled'
  });
}
```

### **3. –£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç—ë–∂**

```javascript
if (event.type === 'invoice.payment_succeeded') {
  // –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂ –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ
  // –ü—Ä–æ–¥–ª–µ–≤–∞–µ–º current_period_end
}
```

### **4. –ù–µ—É–¥–∞—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂**

```javascript
if (event.type === 'invoice.payment_failed') {
  // –ü–ª–∞—Ç—ë–∂ –Ω–µ –ø—Ä–æ—à—ë–ª
  // –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "past_due"
  await admin.database().ref(`profiles/${uid}/usage`).update({
    paid: false,
    status: 'past_due'
  });
}
```

---

## üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Firebase Realtime Database

–ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:

```
firebase-database/
‚îú‚îÄ profiles/
‚îÇ  ‚îî‚îÄ {uid}/                    # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ     ‚îú‚îÄ name: "–ê–ª–µ–∫—Å–µ–π"
‚îÇ     ‚îú‚îÄ role: "Developer"
‚îÇ     ‚îú‚îÄ phone: "+71234567890"
‚îÇ     ‚îú‚îÄ createdAt: 1234567890
‚îÇ     ‚îÇ
‚îÇ     ‚îú‚îÄ usage/                 # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–¥–ø–∏—Å–∫–∞
‚îÇ     ‚îÇ  ‚îú‚îÄ count: 5            # –°–∫–æ–ª—å–∫–æ —ç—Å—Ç–∏–º–µ–π—Ç–æ–≤ —Å–¥–µ–ª–∞–ª
‚îÇ     ‚îÇ  ‚îú‚îÄ paid: true          # –ï—Å—Ç—å –ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞
‚îÇ     ‚îÇ  ‚îú‚îÄ subscriptionId: "sub_xxx"
‚îÇ     ‚îÇ  ‚îú‚îÄ status: "active"
‚îÇ     ‚îÇ  ‚îú‚îÄ currentPeriodEnd: 1735689600000
‚îÇ     ‚îÇ  ‚îî‚îÄ updatedAt: 1234567890
‚îÇ     ‚îÇ
‚îÇ     ‚îî‚îÄ estimates/             # –í—Å–µ —ç—Å—Ç–∏–º–µ–π—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ        ‚îú‚îÄ {executionId1}/
‚îÇ        ‚îÇ  ‚îú‚îÄ projectName: "Website for Cafe"
‚îÇ        ‚îÇ  ‚îú‚îÄ notes: "–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤—ë—Ä—Å—Ç–∫–∞"
‚îÇ        ‚îÇ  ‚îú‚îÄ sharedLink: "https://docs.google.com/..."
‚îÇ        ‚îÇ  ‚îú‚îÄ createdAt: 1234567890
‚îÇ        ‚îÇ  ‚îî‚îÄ operations/       # –ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
‚îÇ        ‚îÇ     ‚îú‚îÄ {pushId1}: {
‚îÇ        ‚îÇ     ‚îÇ    step: "Initializing...",
‚îÇ        ‚îÇ     ‚îÇ    status: "pending",
‚îÇ        ‚îÇ     ‚îÇ    progress: 0
‚îÇ        ‚îÇ     ‚îÇ  }
‚îÇ        ‚îÇ     ‚îú‚îÄ {pushId2}: { ... }
‚îÇ        ‚îÇ     ‚îî‚îÄ {pushId3}: { ... }
‚îÇ        ‚îÇ
‚îÇ        ‚îî‚îÄ {executionId2}/
‚îÇ           ‚îî‚îÄ ...
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

### **–ö–∞–∫ –∑–∞—â–∏—â–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:**

1. **Firebase Auth**:
   - –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `uid`
   - Frontend –ø–æ–ª—É—á–∞–µ—Ç `ID Token` (JWT —Ç–æ–∫–µ–Ω)

2. **Backend endpoints –∑–∞—â–∏—â–µ–Ω—ã**:
   ```javascript
   async function verifyToken(req, res, next) {
     const authHeader = req.headers.authorization;
     const idToken = authHeader.split('Bearer ')[1];
     
     // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ Firebase Admin SDK
     req.user = await admin.auth().verifyIdToken(idToken);
     next();
   }

   // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–∫:
   app.post('/create-subscription', verifyToken, async (req, res) => {
     const uid = req.user.uid; // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π uid
   });
   ```

3. **Database Rules** (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã):
   ```json
   {
     "rules": {
       "profiles": {
         "$uid": {
           ".read": "$uid === auth.uid",
           ".write": "$uid === auth.uid"
         }
       }
     }
   }
   ```
   
   –≠—Ç–æ –∑–Ω–∞—á–∏—Ç: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å/–ø–∏—Å–∞—Ç—å **—Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ**.

---

## üé® Frontend —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### **React Router**

–î–≤–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:
- `/` - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ —Ñ–æ—Ä–º–∞
- `/waiting/:executionId` - –ø—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### **Real-time –ø–æ–¥–ø–∏—Å–∫–∏**

Firebase –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç `onValue()` - —ç—Ç–æ **WebSocket** –ø–æ–¥–ø–∏—Å–∫–∞.

–ö–æ–≥–¥–∞ –≤ –±–∞–∑–µ –º–µ–Ω—è—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ ‚Üí **–º–≥–Ω–æ–≤–µ–Ω–Ω–æ** –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è UI.

–ü—Ä–∏–º–µ—Ä:
```javascript
// –ü–æ–¥–ø–∏—Å–∫–∞
const unsubscribe = onValue(ref, snapshot => {
  console.log('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å!', snapshot.val());
});

// –ü—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
return () => unsubscribe();
```

### **–§–æ—Ä–º—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**

```javascript
const [projectName, setProjectName] = useState('');
const [entries, setEntries] = useState([]);

// –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ input:
<input 
  value={projectName}
  onChange={e => setProjectName(e.target.value)}
/>
```

---

## üîß Backend —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### **Express —Å–µ—Ä–≤–µ—Ä**

```javascript
const app = express();

// Middleware
app.use(cors());           // –†–∞–∑—Ä–µ—à–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
app.use(express.json());   // –ü–∞—Ä—Å–∏—Ç JSON –≤ body

// Routes
app.get('/healthz', ...);
app.post('/create-subscription', ...);
app.post('/stripe-webhook', ...);

app.listen(4000);
```

### **CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**

```javascript
const allowList = [
  'http://localhost:5173',      // Local dev
  'https://ai-estimate-frontend.vercel.app', // Production
];

app.use(cors({
  origin(origin, cb) {
    if (allowList.includes(origin)) {
      cb(null, true);
    } else {
      cb(new Error('CORS blocked'));
    }
  }
}));
```

–≠—Ç–æ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã **—Ç–æ–ª—å–∫–æ —Å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤**.

### **Firebase Admin SDK**

```javascript
admin.initializeApp({
  credential: admin.credential.cert(
    JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT_JSON)
  ),
  databaseURL: process.env.FIREBASE_DB_URL
});

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
await admin.database().ref('profiles/uid123').set({ ... });
await admin.auth().verifyIdToken(token);
```

---

## üìä –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ User    ‚îÇ    ‚îÇ Frontend ‚îÇ    ‚îÇ Firebase ‚îÇ    ‚îÇBackend ‚îÇ    ‚îÇStripe‚îÇ    ‚îÇ n8n  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ Open site    ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ Check auth    ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ  (not authed) ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ Enter phone  ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ Send SMS      ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ    SMS: 123456               ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ                              ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ Enter code   ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ Verify code   ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ  User object  ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ Fill form    ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ Submit       ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ Check limit   ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ count: 1, paid: false        ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ Create progress              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ Send to n8n   ‚îÇ              ‚îÇ            ‚îÇ           ‚îÇ
     ‚îÇ              ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
     ‚îÇ              ‚îÇ                                                        ‚îÇ
     ‚îÇ              ‚îÇ                                          AI processing ‚îÇ
     ‚îÇ              ‚îÇ                                                        ‚îÇ
     ‚îÇ              ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
     ‚îÇ              ‚îÇ  { sharedLink: "..." }                                 ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ Save result   ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ Increment count              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ Redirect to /waiting         ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ Subscribe to operations      ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ<‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï™ (real-time)  ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ See progress ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ Click link   ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ Open Google Docs             ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     
--- –ï–°–õ–ò count >= 3 –∏ paid = false ---

     ‚îÇ Submit (4th) ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ Check limit   ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ count: 3, paid: false        ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ Create checkout              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ                    Get/Create customer     ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ                               ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ                               ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§            ‚îÇ
     ‚îÇ              ‚îÇ                    Create session          ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ                               ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ                               ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§            ‚îÇ
     ‚îÇ              ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ  { sessionId }                ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ Redirect to Stripe           ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ            ‚îÇ
     ‚îÇ                                                           ‚îÇ            ‚îÇ
     ‚îÇ Pay          ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ     Webhook: checkout.completed         ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§            ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ  Update usage             ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ  paid: true  ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ  (real-time update)          ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ<‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï™              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ  usage: { paid: true }       ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ See "unlimited"              ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
     ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§               ‚îÇ              ‚îÇ            ‚îÇ            ‚îÇ
```

---

## ‚öôÔ∏è Environment Variables

### **Frontend (.env)**

```bash
VITE_FIREBASE_API_KEY=...           # Firebase –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
VITE_FIREBASE_AUTH_DOMAIN=...       # –î–æ–º–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
VITE_FIREBASE_PROJECT_ID=...        # ID –ø—Ä–æ–µ–∫—Ç–∞
VITE_FIREBASE_STORAGE_BUCKET=...    # Bucket –¥–ª—è —Ñ–∞–π–ª–æ–≤
VITE_FIREBASE_MESSAGING_SENDER_ID=...
VITE_FIREBASE_APP_ID=...
VITE_FIREBASE_DB_URL=...            # URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

VITE_BACKEND_URL=http://localhost:4000  # URL –±—ç–∫–µ–Ω–¥–∞
VITE_STRIPE_PUBLISHABLE_KEY=pk_...      # –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á Stripe
VITE_STRIPE_PRICE_ID=price_...          # ID –ø—Ä–æ–¥—É–∫—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏
```

### **Backend (backend/.env)**

```bash
# Firebase Admin (–ü–†–ò–í–ê–¢–ù–´–ô!)
FIREBASE_SERVICE_ACCOUNT_JSON={...}  # JSON —Ü–µ–ª–∏–∫–æ–º –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π
FIREBASE_DB_URL=https://...

# Stripe (–ü–†–ò–í–ê–¢–ù–´–ô!)
STRIPE_SECRET_KEY=sk_test_...        # –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á
STRIPE_PRICE_ID=price_...
STRIPE_WEBHOOK_SECRET=whsec_...      # –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ webhook

# Other
FRONTEND_URL=http://localhost:5173
NODE_ENV=development
PORT=4000
```

---

## üö® –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### **1. –ê—Ç–æ–º–∞—Ä–Ω—ã–π –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç**

```javascript
await runTransaction(
  dbRef(rtdb, `profiles/${uid}/usage/count`),
  (c) => (c ?? 0) + 1
);
```

**–ó–∞—á–µ–º?** –ï—Å–ª–∏ –¥–≤–∞ —ç—Å—Ç–∏–º–µ–π—Ç–∞ –æ—Ç–ø—Ä–∞–≤—è—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –æ–±—ã—á–Ω—ã–π `count++` –º–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ.

Transaction –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç: –∫–∞–∂–¥—ã–π –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç —É—á—Ç—ë—Ç—Å—è!

### **2. Webhook –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**

```javascript
// Production
const sig = req.headers['stripe-signature'];
const event = stripe.webhooks.constructEvent(
  req.body,
  sig,
  process.env.STRIPE_WEBHOOK_SECRET
);
```

–≠—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: webhook **–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ—Ç Stripe**, –∞ –Ω–µ –æ—Ç –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞.

### **3. Real-time –ø–æ–¥–ø–∏—Å–∫–∏**

```javascript
useEffect(() => {
  const unsub = onValue(ref, callback);
  return () => unsub(); // –í–ê–ñ–ù–û! –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –ø—Ä–∏ unmount
}, [deps]);
```

–ï—Å–ª–∏ –∑–∞–±—ã—Ç—å `return () => unsub()` ‚Üí –±—É–¥–µ—Ç **memory leak**.

### **4. reCAPTCHA –¥–ª—è SMS**

Firebase —Ç—Ä–µ–±—É–µ—Ç reCAPTCHA –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞ SMS.

–í production –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å **–≤–∏–¥–∏–º–∞—è** –∏–ª–∏ **invisible** –∫–∞–ø—á–∞.

---

## üêõ –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### **–ü—Ä–æ–±–ª–µ–º–∞: "Firebase Database permission denied"**

**–ü—Ä–∏—á–∏–Ω–∞**: Database Rules –Ω–µ —Ä–∞–∑—Ä–µ—à–∞—é—Ç –¥–æ—Å—Ç—É–ø.

**–†–µ—à–µ–Ω–∏–µ**: –û–±–Ω–æ–≤–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –≤ Firebase Console:
```json
{
  "rules": {
    "profiles": {
      "$uid": {
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid"
      }
    }
  }
}
```

### **–ü—Ä–æ–±–ª–µ–º–∞: "CORS error"**

**–ü—Ä–∏—á–∏–Ω–∞**: Frontend URL –Ω–µ –≤ allowList.

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤—å—Ç–µ –≤ `backend/index.js`:
```javascript
const allowList = [
  'http://localhost:5173',
  'https://your-frontend-domain.vercel.app'
];
```

### **–ü—Ä–æ–±–ª–µ–º–∞: Stripe webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**

**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `STRIPE_WEBHOOK_SECRET` –∏–ª–∏ URL.

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Stripe Dashboard ‚Üí Webhooks
2. URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `https://your-backend.com/stripe-webhook`
3. Secret –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å `.env`

### **–ü—Ä–æ–±–ª–µ–º–∞: reCAPTCHA –æ—à–∏–±–∫–∏**

**–ü—Ä–∏—á–∏–Ω–∞**: –ö–∞–ø—á–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –∏–ª–∏ —Å–±—Ä–æ—à–µ–Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `hardResetCaptcha()` –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–æ–π.

---

## üéì –†–µ–∑—é–º–µ: —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ö–æ–¥–∏—Ç** ‚Üí SMS –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Firebase
2. **–ó–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É** ‚Üí –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞, —Ñ–∞–π–ª—ã, –∑–∞–º–µ—Ç–∫–∏
3. **–ù–∞–∂–∏–º–∞–µ—Ç Submit**:
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ª–∏–º–∏—Ç (3 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö)
   - –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É Stripe
   - –ï—Å–ª–∏ –æ–∫ ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ n8n
4. **n8n –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç**:
   - AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ
   - –°–æ–∑–¥–∞—ë—Ç —ç—Å—Ç–∏–º–µ–π—Ç
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Å—ã–ª–∫—É
5. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å** –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
6. **–ü–æ–ª—É—á–∞–µ—Ç —Å—Å—ã–ª–∫—É** –Ω–∞ –≥–æ—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
7. **–û–ø–ª–∞—Ç–∞** (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):
   - Stripe –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É
   - Webhook –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤ Firebase
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç unlimited –¥–æ—Å—Ç—É–ø

---

## üîÆ –ß—Ç–æ –µ—â—ë –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å

1. **–ò—Å—Ç–æ—Ä–∏—è —ç—Å—Ç–∏–º–µ–π—Ç–æ–≤**:
   - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ –ø—Ä–æ—à–ª—ã–µ —ç—Å—Ç–∏–º–µ–π—Ç—ã
   - –ö–Ω–æ–ø–∫–∞ "View all estimates"

2. **–û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏**:
   - –ö–Ω–æ–ø–∫–∞ "Cancel subscription" –≤ UI
   - –ß–µ—Ä–µ–∑ Stripe Customer Portal

3. **Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**:
   - –ö–æ–≥–¥–∞ —ç—Å—Ç–∏–º–µ–π—Ç –≥–æ—Ç–æ–≤
   - –ö–æ–≥–¥–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç

4. **–ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä**:
   - –í–º–µ—Å—Ç–æ —Å–ø–∏—Å–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π - –≤–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å

5. **–î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞**:
   - –°–∫–æ–ª—å–∫–æ —ç—Å—Ç–∏–º–µ–π—Ç–æ–≤ —Å–¥–µ–ª–∞–Ω–æ
   - –°–∫–æ–ª—å–∫–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –¥–µ–Ω–µ–≥

---

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–≠—Ç–æ **–ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ SaaS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** —Å:
- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
- ‚úÖ Real-time –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–æ–π —Ñ–∞–π–ª–æ–≤
- ‚úÖ AI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ n8n
- ‚úÖ –ü–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π
- ‚úÖ Webhook –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- ‚úÖ –õ–∏–º–∏—Ç–∞–º–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ **–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è** –∏ **–±–µ–∑–æ–ø–∞—Å–Ω–∞—è**.

–í—Å–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ best practices —Å–æ–±–ª—é–¥–µ–Ω—ã! üéâ

---

**–í–æ–ø—Ä–æ—Å—ã? –ù—É–∂–Ω—ã —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø–æ –∫–∞–∫–æ–π-—Ç–æ —á–∞—Å—Ç–∏?** –ü–∏—à–∏!

